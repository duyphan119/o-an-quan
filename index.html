<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Ô Ăn Quan</title>
    <style>
      h1 {
        text-align: center;
      }
      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .box {
        align-items: center;
        justify-content: center;
        flex-direction: column;
        display: none;
      }
      .player {
        display: flex;
        align-items: center;
        flex-direction: column;
        margin-left: 0;
        margin-right: 10px;
      }
      .player-avatar {
        width: 80px;
        height: 80px;
        margin-left: 0;
        margin-right: 10px;
      }
      .me .player-avatar {
        margin-left: 10px;
        margin-right: 0;
      }
      .player-avatar img {
        width: inherit;
        height: inherit;
        object-fit: cover;
      }
      .board-wrapper {
        display: flex;
      }
      .mandarin {
        border: 1px solid #000;
        width: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mandarin-left {
        border-top-left-radius: 50px;
        border-bottom-left-radius: 50px;
      }
      .mandarin-right {
        border-top-right-radius: 50px;
        border-bottom-right-radius: 50px;
      }
      .board {
        margin-block: 20px;
      }
      .board-rows {
        /* border: 2px solid #000; */
        color: inherit;
      }
      .board-cols {
        display: flex;
      }
      .board-col {
        width: 80px;
        height: 80px;
        border: 1px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
      }
      .board-col.active {
        background-color: rgb(158, 136, 255);
      }
      .board-col.score {
        background-color: rgb(54, 254, 74);
      }
      .mandarin-right.go,
      .mandarin-left.go,
      .board-col.go {
        background-color: rgb(255, 230, 86);
      }
      .actions {
        display: flex;
        align-items: center;
        margin: 20px 0 10px 0;
      }
      .action {
        margin-inline: 10px;
        padding: 5px 15px;
        background-color: rgb(153, 96, 231);
        border: 1px solid rgb(153, 96, 231);
        color: #fff;
        border-radius: 5px;
        cursor: pointer;
      }
      .action[disabled] {
        cursor: not-allowed;
      }
      .timer {
        margin-block: 10px;
      }
      .timer span {
        background-color: #f8a;
        padding: 2px 10px;
        border-radius: 5px;
      }
      .d-flex {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h1>Game ô ăn quan</h1>
      <button class="play">Chơi ngay</button>
      <a
        href="https://hocvienboardgame.vn/huong-dan-tro-choi-o-an-quan/"
        class="link"
        >Đọc luật chơi theo đường dẫn này</a
      >
      <div class="box">
        <div class="player competitor">
          <div class="player-avatar">
            <img src="./1156419.png" alt="" />
          </div>
          <div class="player-name">MÁY</div>
        </div>
        <div>Điểm của máy: <span class="your-score">0</span></div>
        <div class="board">
          <div class="board-wrapper">
            <div class="mandarin mandarin-left">10</div>
            <ul class="board-rows">
              <li class="board-row">
                <ul class="board-cols">
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                </ul>
              </li>
              <li class="board-row">
                <ul class="board-cols">
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                  <li class="board-col">5</li>
                </ul>
              </li>
            </ul>
            <div class="mandarin mandarin-right">10</div>
          </div>
        </div>
        <div class="player me">
          <div class="player-avatar">
            <img src="./player_default.png" width="50" alt="" />
          </div>
          <div class="player-name">BẠN</div>
        </div>
        <div class="actions">
          <button class="action action-left" disabled="true" type="button">
            Qua trái
          </button>
          <button class="action action-right" disabled="true" type="button">
            Qua phải
          </button>
        </div>
        <div>Lượt của: <span class="my-turn">Tôi</span></div>
        <div>Điểm của tôi: <span class="my-score">0</span></div>
        <div class="timer"><span>02:00</span></div>
        <div class="d-flex">
          <button class="replay">Chơi lại</button>&nbsp;&nbsp;
          <button class="exit">Thoát</button>
        </div>
      </div>
    </div>
    <script>
      const boxDOM = document.querySelector(".box");
      const cols = document.querySelectorAll(".board-col");
      const timer = document.querySelector(".timer span");
      const btnLeft = document.querySelector(".action-left");
      const btnRight = document.querySelector(".action-right");
      const mandarinLeft = document.querySelector(".mandarin-left");
      const mandarinRight = document.querySelector(".mandarin-right");
      const myScoreDOM = document.querySelector(".my-score");
      const myTurnDOM = document.querySelector(".my-turn");
      const yourScoreDOM = document.querySelector(".your-score");
      const btnPlay = document.querySelector(".play");
      const btnExit = document.querySelector(".exit");
      const btnReplay = document.querySelector(".replay");
      const link = document.querySelector(".link");
      // constants
      const TIME_PER_TURN = 30;
      const DIRECTION_LEFT = -1;
      const DIRECTION_RIGHT = 1;

      let timerId;
      let myBoard = new Array(5).fill(1).map((item) => 5);
      let yourBoard = new Array(5).fill(1).map((item) => 5);
      // let yourBoard = [0, 5, 0, 5, 0];
      // let myBoard = [0, 5, 0, 5, 1];
      let isPlaying = false;
      let countDown = TIME_PER_TURN;
      let countDownStart = true;
      let myIndexCol = 0;
      let isInMyBoard = true;
      let yourIndexCol;
      let direction;
      let count = 0;
      let myScore = 0;
      let yourScore = 0;
      let isGoing = false;
      let myTurn = true;
      let x = 0;
      window.onload = start;

      function start() {
        addEvents();
      }

      function addEvents() {
        btnPlay.addEventListener("click", function () {
          boxDOM.style.display = "flex";
          this.style.display = "none";
          btnExit.style.display = "block";
          link.style.display = "none";
          isPlaying = true;
          timerId = setInterval(play, 500);
          countDown = 0;
          countDownStart = true;
          printCountDown();
        });
        btnExit.addEventListener("click", function () {
          boxDOM.style.display = "none";
          this.style.display = "none";
          btnPlay.style.display = "block";
          isPlaying = false;
          link.style.display = "block";
        });
        btnReplay.addEventListener("click", function () {
          myBoard = new Array(5).fill(1).map((item) => 5);
          yourBoard = new Array(5).fill(1).map((item) => 5);
          count = 0;
          myScore = 0;
          yourScore = 0;
          isGoing = false;
          myTurn = true;
          myScoreDOM.textContent = myScore;
          yourScoreDOM.textContent = yourScore;
          timerId = setInterval(play, 500);
          x = 0;
          countDownStart = true;
          isInMyBoard = true;
          countDown = TIME_PER_TURN;
          isPlaying = true;
          cols.forEach((col, index) => {
            col.textContent = 5;
          });
          mandarinLeft.textContent = 10;
          mandarinRight.textContent = 10;
        });
        cols.forEach((col, index) => {
          col.addEventListener("click", function (e) {
            if (!isGoing && myTurn) {
              if (index > 4) {
                cancelActiveAllCol();

                e.target.classList.add("active");
                myIndexCol = index - 5;
                setEnabled(myBoard[myIndexCol] !== 0, [btnLeft, btnRight]);
              }
            }
          });
        });

        btnLeft.addEventListener("click", function () {
          directionBtnClick(DIRECTION_LEFT);
        });

        btnRight.addEventListener("click", function () {
          directionBtnClick(DIRECTION_RIGHT);
        });
      }

      function cancelActiveAllCol() {
        cols.forEach((col) => {
          col.classList.remove("active");
        });
      }

      function setEnabled(status, targets) {
        targets.forEach((target) => {
          if (status) {
            target.removeAttribute("disabled");
          } else {
            target.setAttribute("disabled", !status);
          }
        });
      }

      function directionBtnClick(_direction) {
        direction = _direction;
        countDownStart = false;
        count = myBoard[myIndexCol];
        cols[myIndexCol + 5].textContent = 0;
        myBoard[myIndexCol] = 0;
        isGoing = true;
        setEnabled(false, [btnLeft, btnRight]);
        x = 0;
      }

      function play() {
        if (isPlaying) {
          if (countDownStart) {
            printCountDown();
            x++;
          } else {
            x = 0;
            if (isGoing) {
              updateBoard();
            } else {
              countDown = 0;
              setScore();
              cancelActiveAllCol();
              if (isInMyBoard) {
                if (myIndexCol >= 0 && myIndexCol <= 4) {
                  cols[myIndexCol + 5].classList.remove("go");
                }
              } else {
                if (cols[yourIndexCol]) {
                  cols[yourIndexCol].classList.remove("go");
                }
              }
              if (!gameOver()) {
                if (myTurn) {
                  if (checkEqual0(yourBoard)) {
                    yourScore -= 5;
                    yourScoreDOM.textContent = yourScore;
                    yourBoard = yourBoard.map((item, index) => {
                      cols[index].textContent = 1;
                      return 1;
                    });
                  }

                  setEnabled(true, [btnLeft, btnRight]);

                  // clearInterval(timerId);

                  direction = DIRECTION_RIGHT;
                  yourIndexCol = 2;

                  randomDirection();
                  randomYourIndexCol();
                  countDownStart = false;
                  count = yourBoard[yourIndexCol];
                  cols[yourIndexCol].textContent = 0;
                  yourBoard[yourIndexCol] = 0;
                  isInMyBoard = false;
                  setEnabled(false, [btnLeft, btnRight]);
                  myTurn = false;
                  myTurnDOM.textContent = "Máy";
                  isGoing = true;
                } else {
                  // Tính điểm của máy
                  if (checkEqual0(myBoard)) {
                    myScore -= 5;
                    myBoard = myBoard.map((item, index) => {
                      cols[index + 5].textContent = 1;
                      return 1;
                    });
                    myScoreDOM.textContent = myScore;
                  }
                  myTurn = true;
                  countDownStart = true;
                  myTurnDOM.textContent = "Tôi";
                  isInMyBoard = true;
                }
              } else {
                clearInterval(timerId);
                setTimeout(() => {
                  let msg = `${yourScore > myScore ? "MÁY" : "BẠN"} THẮNG`;
                  if (yourScore === myScore) {
                    if (sumArr(myBoard) > sumArr(yourBoard)) {
                      msg = `BẠN THẮNG`;
                    } else {
                      msg = `MÁY THẮNG`;
                    }
                  }
                  window.alert(msg);
                }, 1000);
              }
            }
          }
        } else {
          clearInterval(timerId);
        }
      }

      function randomDirection() {
        const random = Math.random();
        if (random > 0.5) {
          direction = DIRECTION_LEFT;
        } else {
          direction = DIRECTION_RIGHT;
        }
      }

      function checkEqual0(board) {
        for (let i = 0; i < board.length; i++) {
          if (board[i] !== 0) {
            return false;
          }
        }
        return true;
      }

      function randomYourIndexCol() {
        let random;
        // Nếu hàng trên bằng 0 hết

        do {
          random = Math.floor(Math.random() * 5);
        } while (yourBoard[random] === 0);
        yourIndexCol = random;
        cols[yourIndexCol].classList.add("active");
      }

      function getScore() {
        let nextIndex = (isInMyBoard ? myIndexCol : yourIndexCol) + direction;
        let _isInMyBoard = isInMyBoard;
        let _direction = direction;
        let score = 0;
        let i = 10;
        //Tính điểm hàng dưới
        while (i !== 0) {
          let indexValue = nextIndex + _direction;
          if (
            (myIndexCol >= -1 && myIndexCol <= myBoard.length) ||
            (yourIndexCol >= -1 && yourIndexCol <= yourBoard.length)
          ) {
            //Nếu ô kế tiếp trống
            if (_isInMyBoard) {
              if (myBoard[nextIndex] === 0) {
                // cols[nextIndex + 5].classList.add("score");
                if (
                  indexValue <= -1 &&
                  parseInt(mandarinLeft.textContent) !== 0
                ) {
                  score += parseInt(mandarinLeft.textContent);
                  mandarinLeft.textContent = 0;
                  _direction *= -1;
                  _isInMyBoard = !_isInMyBoard;
                } else if (
                  indexValue >= myBoard.length &&
                  parseInt(mandarinRight.textContent) !== 0
                ) {
                  score += parseInt(mandarinRight.textContent);
                  mandarinRight.textContent = 0;
                  _direction *= -1;
                  _isInMyBoard = !_isInMyBoard;
                } else {
                  if (myBoard[indexValue] !== 0) {
                    score += myBoard[indexValue];
                    myBoard[indexValue] = 0;
                    cols[indexValue + 5].textContent = 0;
                  } else {
                    break;
                  }
                }
                // cols[nextIndex + 5].classList.remove("score");
                nextIndex = indexValue + _direction;
              } else {
                break;
              }
            } else {
              if (yourBoard[nextIndex] === 0) {
                // cols[nextIndex].classList.add("score");
                if (
                  indexValue <= -1 &&
                  parseInt(mandarinLeft.textContent) !== 0
                ) {
                  score += parseInt(mandarinLeft.textContent);
                  mandarinLeft.textContent = 0;
                  _direction *= -1;
                  _isInMyBoard = !_isInMyBoard;
                } else if (
                  indexValue >= yourBoard.length &&
                  parseInt(mandarinRight.textContent) !== 0
                ) {
                  score += parseInt(mandarinRight.textContent);
                  mandarinRight.textContent = 0;
                  _direction *= -1;
                  _isInMyBoard = !_isInMyBoard;
                } else {
                  if (yourBoard[indexValue] !== 0) {
                    score += yourBoard[indexValue];
                    yourBoard[indexValue] = 0;
                    cols[indexValue].textContent = 0;
                  } else {
                    break;
                  }
                }
                // cols[nextIndex].classList.remove("score");
                nextIndex = indexValue + _direction;
              } else {
                break;
              }
            }
          }
          //Nếu vị trí kế tiếp là quan
          else {
            break;
          }
          i--;
        }
        return score;
      }

      function setScore() {
        if (myTurn) {
          myScore += getScore();
          myScoreDOM.textContent = myScore;
        } else {
          yourScore += getScore();
          yourScoreDOM.textContent = yourScore;
        }
      }

      function cancelGo() {
        cols.forEach((col) => {
          if (col.classList.contains("go")) col.classList.remove("go");
        });
      }

      function updateMyBoard() {
        if (count > 0 && isInMyBoard) {
          cancelGo();
          let newMyIndexCol = myIndexCol + direction;
          if (newMyIndexCol > -1 && newMyIndexCol < myBoard.length) {
            if (
              direction === DIRECTION_LEFT &&
              newMyIndexCol === myBoard.length - 1
            ) {
              mandarinRight.classList.remove("go");
            } else if (direction === DIRECTION_RIGHT && newMyIndexCol === 0) {
              mandarinLeft.classList.remove("go");
            }
            cols[newMyIndexCol + 5].classList.add("go");
            myBoard[newMyIndexCol] = myBoard[newMyIndexCol] + 1;
            cols[newMyIndexCol + 5].textContent = myBoard[newMyIndexCol];
          } else if (newMyIndexCol === -1) {
            mandarinLeft.classList.add("go");
            mandarinLeft.textContent = parseInt(mandarinLeft.textContent) + 1;
            newMyIndexCol = 0;
            isInMyBoard = !isInMyBoard;
            direction *= -1;
            yourIndexCol = -1;
          } else {
            mandarinRight.classList.add("go");
            mandarinRight.textContent = parseInt(mandarinRight.textContent) + 1;
            isInMyBoard = !isInMyBoard;
            direction *= -1;
            yourIndexCol = yourBoard.length;
          }
          count--;
          myIndexCol = newMyIndexCol;
        } else if (count === 0) {
          let newMyIndexCol = myIndexCol + direction;
          let isStopped = isStopMyBoard(newMyIndexCol);
          if (!isStopped && isInMyBoard) {
            if (newMyIndexCol >= 0 && newMyIndexCol < myBoard.length) {
              count = myBoard[newMyIndexCol];
              myBoard[newMyIndexCol] = 0;
              cols[newMyIndexCol + 5].textContent = myBoard[newMyIndexCol];
              myIndexCol = newMyIndexCol;
            }
          } else if (isStopped && isInMyBoard) {
            isGoing = false;
          }
        }
      }

      function isStopMyBoard(newMyIndexCol) {
        if (count !== 0) {
          return false;
        }
        if (isInMyBoard) {
          //Xét hàng dưới
          // vị trí kế tiếp
          // Nếu đi qua trái
          if (direction === DIRECTION_LEFT) {
            // Nếu vị trí hiện tại đứng kế quan
            if (myIndexCol === 0) {
              return true;
            }
          } else {
            if (myIndexCol === myBoard.length - 1) {
              return true;
            }
          }
          // Nếu ô kế tiếp = 0
          if (myBoard[newMyIndexCol] === 0) {
            return true;
          }
          return false;
        } else {
          return true;
        }
      }

      function isStopYourBoard(newYourIndexCol) {
        if (count !== 0) {
          return false;
        }
        if (!isInMyBoard) {
          // Xét hàng trên
          // vị trí kế tiếp

          // Nếu đi qua trái
          if (direction === DIRECTION_LEFT) {
            // Nếu vị trí hiện tại đứng kế quan
            if (yourIndexCol === 0) {
              return true;
            }
          } else {
            if (yourIndexCol === yourBoard.length - 1) {
              return true;
            }
          }
          // Nếu ô kế tiếp = 0
          if (yourBoard[newYourIndexCol] === 0) {
            return true;
          }
          return false;
        } else {
          return true;
        }
      }

      function updateBoard() {
        mandarinRight.classList.remove("go");
        mandarinLeft.classList.remove("go");
        if (count > 0 && !isInMyBoard) {
          cancelGo();
          let newYourIndexCol = yourIndexCol + direction;
          if (newYourIndexCol > -1 && newYourIndexCol < myBoard.length) {
            cols[newYourIndexCol].classList.add("go");
            yourBoard[newYourIndexCol] = yourBoard[newYourIndexCol] + 1;
            cols[newYourIndexCol].textContent = yourBoard[newYourIndexCol];
          } else if (newYourIndexCol === -1) {
            mandarinLeft.classList.add("go");
            mandarinLeft.textContent = parseInt(mandarinLeft.textContent) + 1;
            newYourIndexCol = 0;
            isInMyBoard = !isInMyBoard;
            direction *= -1;
            myIndexCol = -1;
          } else {
            mandarinRight.classList.add("go");
            mandarinRight.textContent = parseInt(mandarinRight.textContent) + 1;
            isInMyBoard = !isInMyBoard;
            direction *= -1;
            myIndexCol = myBoard.length;
          }
          count--;
          yourIndexCol = newYourIndexCol;
        } else if (count > 0 && isInMyBoard) {
          cancelGo();
          let newMyIndexCol = myIndexCol + direction;
          if (newMyIndexCol > -1 && newMyIndexCol < myBoard.length) {
            cols[newMyIndexCol + 5].classList.add("go");
            myBoard[newMyIndexCol] = myBoard[newMyIndexCol] + 1;
            cols[newMyIndexCol + 5].textContent = myBoard[newMyIndexCol];
          } else if (newMyIndexCol === -1) {
            mandarinLeft.classList.add("go");
            mandarinLeft.textContent = parseInt(mandarinLeft.textContent) + 1;
            newMyIndexCol = 0;
            isInMyBoard = !isInMyBoard;
            direction *= -1;
            yourIndexCol = -1;
          } else {
            mandarinRight.classList.add("go");
            mandarinRight.textContent = parseInt(mandarinRight.textContent) + 1;
            isInMyBoard = !isInMyBoard;
            direction *= -1;
            yourIndexCol = yourBoard.length;
          }
          count--;
          myIndexCol = newMyIndexCol;
        } else if (count === 0) {
          let newMyIndexCol = myIndexCol + direction;
          let isStopped1 = isStopMyBoard(newMyIndexCol);
          if (!isStopped1 && isInMyBoard) {
            if (newMyIndexCol >= 0 && newMyIndexCol < myBoard.length) {
              count = myBoard[newMyIndexCol];
              myBoard[newMyIndexCol] = 0;
              cols[newMyIndexCol + 5].textContent = myBoard[newMyIndexCol];
              myIndexCol = newMyIndexCol;
            }
          } else if (isStopped1 && isInMyBoard) {
            isGoing = false;
          }
          let newYourIndexCol = yourIndexCol + direction;
          let isStopped = isStopYourBoard(newYourIndexCol);
          if (!isStopped && !isInMyBoard) {
            count = yourBoard[newYourIndexCol];
            yourBoard[newYourIndexCol] = 0;
            cols[newYourIndexCol].textContent = yourBoard[newYourIndexCol];
            yourIndexCol = newYourIndexCol;
          } else if (isStopped && !isInMyBoard) {
            isGoing = false;
          }
        }
      }

      function printCountDown() {
        if (x % 2 === 0) {
          if (countDown === 0) {
            clearInterval(timerId);
            setTimeout(() => {
              let msg = `${yourScore > myScore ? "MÁY" : "BẠN"} THẮNG`;
              if (yourScore === myScore) {
                if (sumArr(myBoard) > sumArr(yourBoard)) {
                  msg = `BẠN THẮNG`;
                } else {
                  msg = `MÁY THẮNG`;
                }
              }
              window.alert(msg);
            }, 1000);
            countDown = TIME_PER_TURN;
          } else {
            countDown -= 1;
          }
          const minute = Math.floor(countDown / 60);
          const second = countDown - minute * 60;
          timer.textContent = `${minute < 10 ? "0" + minute : minute}:${
            second < 10 ? "0" + second : second
          }`;
        }
      }

      function gameOver() {
        if (
          mandarinLeft.textContent === "0" &&
          mandarinRight.textContent === "0"
        ) {
          return true;
        }
        return false;
      }

      function sumArr(arr) {
        let result = 0;
        arr.forEach((item) => {
          result += item;
        });
        return result;
      }
    </script>
  </body>
</html>
